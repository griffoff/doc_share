---
title: RBAC Strategy
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowflake RBAC Strategy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
            color: #1e293b; /* Tailwind slate-800 */
        }

        /* --- Presentation Container --- */
        #presentation-container {
            width: 100%;
            max-width: 1100px;
            margin: 2rem auto;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid #e2e8f0; /* Tailwind slate-200 */
        }
        
        #slide-window {
            width: 100%;
            overflow: hidden;
        }

        #slide-deck {
            display: flex;
            width: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide {
            width: 100%;
            flex-shrink: 0;
            padding: 3rem 4rem; /* More padding */
            min-height: 550px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- Navigation --- */
        #nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: #f1f5f9; /* Tailwind slate-100 */
            border-top: 1px solid #e2e8f0; /* Tailwind slate-200 */
        }
        #slide-counter {
            font-size: 0.9rem;
            font-weight: 500;
            color: #475569; /* Tailwind slate-600 */
        }
        .nav-button {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .nav-button:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        .nav-button:disabled {
            background-color: #94a3b8; /* Tailwind slate-400 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Slide Content --- */
        .slide h1 {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
            color: #0f172a; /* Tailwind slate-900 */
            margin-bottom: 0.5rem;
        }
        .slide .subtitle {
            font-size: 1.25rem; /* 20px */
            font-weight: 500;
            color: #3b82f6; /* Tailwind blue-500 */
            margin-bottom: 2rem;
        }
        .slide p {
            font-size: 1.1rem; /* 18px */
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }
        .slide h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: #1e293b; /* Tailwind slate-800 */
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        .slide h3 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #334155; /* Tailwind slate-700 */
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .slide ul, .slide ol {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .slide li {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 0.75rem;
            list-style-type: disc;
        }
        .slide ol li {
            list-style-type: decimal;
        }
        .slide code {
            background-color: #e2e8f0; /* slate-200 */
            color: #dd1144; /* A common color for code */
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.95em;
        }
        
        /* --- Flexbox for Pillars/Pitfalls --- */
        .two-col-container {
            display: flex;
            gap: 2rem;
            width: 100%;
        }
        .two-col-item {
            flex: 1;
            background-color: #f8fafc; /* gray-50 */
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        /* Responsive stacking for two-col */
        @media (max-width: 820px) {
            .two-col-container {
                flex-direction: column;
            }
        }

        /* --- Alert / Pitfall Box --- */
        .pitfall-box {
            border-left: 4px solid #ef4444; /* Tailwind red-500 */
            background-color: #fee2e2; /* Tailwind red-100 */
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .pitfall-box strong {
            color: #b91c1c; /* Tailwind red-800 */
            font-weight: 600;
            font-size: 1.1em;
            display: block;
            margin-bottom: 0.5rem;
        }
        .pitfall-box p {
            color: #b91c1c; /* Tailwind red-800 */
            margin: 0;
        }
        
        /* --- Best Practice Box --- */
        .practice-box {
            border-left: 4px solid #22c55e; /* Tailwind green-500 */
            background-color: #f0fdf4; /* Tailwind green-50 */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .practice-box h3 {
            margin-top: 0;
            color: #15803d; /* Tailwind green-800 */
        }
        .practice-box ul li {
            color: #166534; /* Tailwind green-900 */
        }
        
        /* --- Policy Box --- */
        .policy-box {
            border: 2px solid #3b82f6; /* Tailwind blue-500 */
            background-color: #eff6ff; /* Tailwind blue-50 */
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        .policy-box ul li {
            color: #1e3a8a; /* Tailwind blue-900 */
            font-weight: 500;
        }

        /* --- Collapsible Code --- */
        .collapsible-trigger {
            background-color: #f1f5f9; /* slate-100 */
            color: #0f172a; /* slate-900 */
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            width: 100%;
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 5px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s;
            margin-top: 1rem;
            position: relative;
        }
        .collapsible-trigger:hover {
            background-color: #e2e8f0; /* slate-200 */
        }
        .collapsible-trigger::after {
            content: '+';
            font-size: 1.25rem;
            color: #3b82f6; /* blue-500 */
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .collapsible-trigger.active::after {
            content: "−";
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #fdfdfd;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            position: relative; /* Added for copy button positioning */
        }
        .collapsible-content pre {
            background-color: #2c3e50; /* Dark background for code */
            color: #ecf0f1; /* Light text */
            padding: 1.5rem;
            padding-top: 2.5rem; /* Make space for copy button */
            border-radius: 0 0 5px 5px;
            margin: 0;
            line-height: 1.5;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        /* We reset the 'code' styles inside the 'pre' block */
        .collapsible-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
            font-size: 1em;
        }
        /* SQL Syntax Highlighting */
        .collapsible-content .sql-keyword { color: #5dade2; font-weight: bold; } /* Blue */
        .collapsible-content .sql-string { color: #e67e22; } /* Orange */
        .collapsible-content .sql-comment { color: #95a5a6; font-style: italic; } /* Gray */
        
        /* --- Copy Button Styles --- */
        .copy-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: #95a5a6;
            color: #ecf0f1;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            opacity: 0.8;
            z-index: 10;
        }
        .copy-button:hover {
            background-color: #7f8c8d;
            opacity: 1;
        }
        .copy-button.copied {
            background-color: #16a085; /* Green for success */
            color: white;
        }
        /* --- End Copy Button Styles --- */
        
        /* Documentation Excerpts */
        .doc-excerpt {
            border-left: 4px solid #94a3b8; /* slate-400 */
            background-color: #f8fafc; /* gray-50 */
            padding: 1.5rem;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .doc-excerpt blockquote {
            font-style: italic;
            color: #475569; /* slate-600 */
            margin: 0;
            margin-bottom: 1rem;
        }
        .doc-excerpt a {
            color: #3b82f6; /* blue-500 */
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }
        .doc-excerpt a:hover {
            color: #2563eb; /* blue-600 */
            text-decoration: underline;
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="presentation-container">
        
        <!-- Slide Window -->
        <div id="slide-window">
            <div id="slide-deck">

                <!-- Slide 1: Title -->
                <div class="slide" id="slide1">
                    <h1>Refining Our Access Control Strategy</h1>
                    <p class="subtitle">Moving to a Secure, Scalable, and Automated RBAC Model</p>
                    <p>This presentation outlines a robust, hierarchical Role-Based Access Control (RBAC) model for our Snowflake environment. The goal is to evolve from our current state to a system that is secure, manageable, and built on clear principles.</p>
                    <p>We will review key concepts, a formal policy, and an end-to-end test script to prove the model's validity.</p>
                </div>

                <!-- Slide 2: Key Principles -->
                <div class="slide" id="slide2">
                    <h1>Three Key Principles</h1>
                    <p class="subtitle">These concepts are the foundation of our entire strategy.</p>
                    <div class="two-col-container">
                        <div class="two-col-item">
                            <h3>1. Clear Ownership</h3>
                            <p>Every object must have a clear owner. We must distinguish between:</p>
                            <ul>
                                <li><strong>Functional Owner (a Role):</strong> A stable, personless database role (e.g., <code>SCHEMA_OWNER_FINANCE</code>) that *technically* owns all objects.</li>
                                <li><strong>Accountable Owner (a Person):</strong> The business or data steward responsible for the asset's lifecycle, tracked in our governance tool.</li>
                            </ul>
                        </div>
                        <div class="two-col-item">
                            <h3>2. Multi-Dimensional Inheritance</h3>
                            <p>Permissions should be inherited through two separate hierarchies:</p>
                            <ul>
                                <li><strong>Scope (The "Where"):</strong> What you can access. (e.g., <code>SCHEMA_FINANCE</code> -> <code>DB_PRODUCTION</code>)</li>
                                <li><strong>Privilege (The "What"):</strong> What you can do. (e.g., <code>READONLY</code> -> <code>READWRITE</code> -> <code>FULL_ACCESS</code>)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="two-col-container" style="margin-top: 2rem;">
                        <div class="two-col-item" style="flex: 100%;">
                            <h3>3. Automation</h3>
                            <p>All permissions must be manageable through code. By separating ownership and privilege, we can create an automated, testable, and idempotent system. This model ensures future objects automatically inherit the correct ownership and permissions, eliminating manual errors.</p>
                        </div>
                    </div>
                </div>

                <!-- Slide 3: Pillar 1 - Ownership -->
                <div class="slide" id="slide3">
                    <h1>Pillar 1: Clear Ownership</h1>
                    <p class="subtitle">Separating technical ownership from business accountability.</p>
                    
                    <h3>Functional Owner (The Role)</h3>
                    <p>This is a database role (e.g., <code>SCHEMA_OWNER_FINANCE</code>). Its *only* job is to own objects. By using <code>GRANT OWNERSHIP ON FUTURE...</code>, we ensure this role automatically owns any new object created in the schema, *regardless of who creates it*. This solves the "developer left the company" problem.</p>
                    <button class="collapsible-trigger">Show Code Example: Functional Ownership (Snowflake)</button>
                    <div class="collapsible-content">
                        <button class="copy-button" title="Copy to clipboard">Copy</button>
                        <pre><code class="language-sql"><span class="sql-comment">-- Example: Assigning stable, role-based ownership</span>

<span class="sql-comment">-- 1. Create the stable, personless role (per-schema)</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> SCHEMA_OWNER_FINANCE;
<span class="sql-keyword">GRANT ROLE</span> SCHEMA_OWNER_FINANCE <span class="sql-keyword">TO ROLE</span> SYSADMIN;

<span class="sql-comment">-- 2. Grant it usage on the schema</span>
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;

<span class="sql-comment">-- 3. Grant it OWNERSHIP on all FUTURE tables, views, etc.</span>
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE VIEWS IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;

<span class="sql-comment">-- 4. Grant this ownership role to any role that needs to CREATE objects</span>
<span class="sql-comment">-- (like an FA or ETL role) so their objects are auto-owned.</span>
<span class="sql-keyword">GRANT ROLE</span> SCHEMA_OWNER_FINANCE <span class="sql-keyword">TO ROLE</span> FINANCE_FA;
</code></pre>
                    </div>

                    <h3>Accountable Owner (The Person)</h3>
                    <p>This is the business steward, tracked in **Collibra**. Collibra is our source of truth for accountability. This metadata (e.g., "Owner: pete.g@company.com") can be pushed from Collibra to the database <code>COMMENT</code> field for technical reference, but Collibra remains the system of record.</p>
                    <button class="collapsible-trigger">Show Code Example: Assigning Accountability (Snowflake)</button>
                    <div class="collapsible-content">
                        <button class="copy-button" title="Copy to clipboard">Copy</button>
                        <pre><code class="language-sql"><span class="sql-comment">-- Example: Using Snowflake COMMENT field</span>
<span class="sql-comment">-- This metadata is pushed from Collibra via an</span>
<span class="sql-comment">-- automated process. It is for reference only.</span>
<span class="sql-keyword">COMMENT ON SCHEMA</span> FINANCE <span class="sql-keyword">IS</span> 
  <span class="sql-string">'{
    "AccountableOwner": "pete.g@company.com",
    "CollibraAssetID": "1a2b3c4d-5e6f-7a8b-9c0d",
    "Description": "Contains financial transaction and ledger data."
  }'</span>;
</code></pre>
                    </div>
                </div>

                <!-- Slide 4: Pillar 2 - Inheritance -->
                <div class="slide" id="slide4">
                    <h1>Pillar 2: Multi-Dimensional Inheritance</h1>
                    <p class="subtitle">Combining "Where" and "What" for granular, clean permissions.</p>
                    <p>We will no longer grant privileges directly to users. Instead, we build two hierarchies that are combined into a final "Business Role."</p>

                    <div class="two-col-container">
                        <div class="two-col-item">
                            <h3>Scope Hierarchy (The "Where")</h3>
                            <p>This defines *what data* can be accessed, typically by schema. These are abstract roles.</p>
                            <ul>
                                <li><code>DATABASE_RBAC_TESTING</code></li>
                                <li><code>SCHEMA_FINANCE</code></li>
                                <li><code>SCHEMA_SALES</code></li>
                            </ul>
                            <button class="collapsible-trigger">Show Code Example: Scope Hierarchy (Snowflake)</button>
                            <div class="collapsible-content">
                                <button class="copy-button" title="Copy to clipboard">Copy</button>
                                <pre><code class="language-sql"><span class="sql-comment">-- Granting at the SCHEMA level (The "Where")</span>
<span class="sql-comment">-- All tables/views created IN 'Finance'</span>
<span class="sql-comment">-- will be covered by this grant.</span>

<span class="sql-comment">-- 1. Create the base privilege role</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_READONLY;

<span class="sql-comment">-- 2. Grant the "What" (SELECT)</span>
<span class="sql-keyword">GRANT SELECT ON ALL TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;
<span class="sql-keyword">GRANT SELECT ON FUTURE TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;

<span class="sql-comment">-- 3. Grant schema usage</span>
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;
</code></pre>
                            </div>
                        </div>

                        <div class="two-col-item">
                            <h3>Privilege Hierarchy (The "What")</h3>
                            <p>This defines *what actions* can be taken. These roles inherit from each other in a clean stack.</p>
                            <ul>
                                <li><code>finance_READONLY</code> (SELECT)</li>
                                <li>...which is granted to <code>finance_RW</code> (INSERT, UPDATE)</li>
                                <li>...which is granted to <code>finance_FA</code> (ALL)</li>
                            </ul>
                            <button class="collapsible-trigger">Show Code Example: Privilege Hierarchy (Snowflake)</button>
                            <div class="collapsible-content">
                                <button class="copy-button" title="Copy to clipboard">Copy</button>
                                <pre><code class="language-sql"><span class="sql-comment">-- This example shows the full 4-layer model</span>

<span class="sql-comment">-- 1. Create Base Privilege Roles for FINANCE schema</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_READONLY;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_RW;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_FA;

<span class="sql-comment">-- 2. Create Privilege stack (RW inherits RO, FA inherits RW)</span>
<span class="sql-keyword">GRANT ROLE</span> finance_READONLY <span class="sql-keyword">TO ROLE</span> finance_RW;
<span class="sql-keyword">GRANT ROLE</span> finance_RW <span class="sql-keyword">TO ROLE</span> finance_FA;

<span class="sql-comment">-- 3. Create Functional Role (e.g., Data Scientist)</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> DATASCIENTIST;
<span class="sql-keyword">GRANT ROLE</span> finance_RW <span class="sql-keyword">TO ROLE</span> DATASCIENTIST; <span class="sql-comment">-- RW on Finance</span>
<span class="sql-keyword">GRANT ROLE</span> sales_READONLY <span class="sql-keyword">TO ROLE</span> DATASCIENTIST; <span class="sql-comment">-- RO on Sales</span>

<span class="sql-comment">-- 4. Create Business Role (This is what a user gets)</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">GRANT ROLE</span> DATASCIENTIST <span class="sql-keyword">TO ROLE</span> Finance_Analyst_User;

<span class="sql-comment">-- 5. Grant Business Role to a user</span>
<span class="sql-keyword">GRANT ROLE</span> Finance_Analyst_User <span class="sql-keyword">TO USER</span> "pete.g";
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide 5: The Full 4-Layer Model -->
                <div class="slide" id="slide5">
                    <h1>The Full 4-Layer Model</h1>
                    <p class="subtitle">This is how all the pieces fit together.</p>
                    
                    <ol>
                        <li><strong>[User]</strong> <code>"pete.g"</code></li>
                        <li style="list-style-type: '⬇️'; padding-left: 0.5rem;">Is granted...</li>
                        
                        <li><strong>Business Role:</strong> <code>Finance_Analyst_User</code></li>
                        <li style="list-style-type: '⬇️'; padding-left: 0.5rem;">Is granted...</li>
                        
                        <li><strong>Functional Role:</strong> <code>DATASCIENTIST</code></li>
                        <li style="list-style-type: '⬇️'; padding-left: 0.5rem;">Is granted...</li>
                        
                        <li><strong>Privilege Roles (Base):</strong>
                            <ul>
                                <li><code>finance_RW</code> (RW on Finance schema)</li>
                                <li><code>sales_READONLY</code> (RO on Sales schema)</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <p>This structure gives us maximum flexibility. If a user moves teams, we simply revoke the <code>Finance_Analyst_User</code> role and grant them <code>Sales_Analyst_User</code>. We never have to touch the complex base permissions.</p>
                    <p>Accountability is tracked in **Collibra**, and the <code>COMMENT</code> fields in Snowflake are updated from Collibra as the system of record.</p>
                </div>

                <!-- Slide 6: Current State: Pitfalls -->
                <div class="slide" id="slide6">
                    <h1>Reviewing Our Current State: Potential Pitfalls</h1>
                    <p class="subtitle">These are the anti-patterns we must move away from.</p>
                    
                    <div class="pitfall-box">
                        <strong>Pitfall 1: Manual, One-Off Grants</strong>
                        <p>Granting privileges (e.g., <code>SELECT ON table1</code>) directly to a user or a broad role. This is unmanageable, untestable, and impossible to audit. It bypasses our entire inheritance model.</p>
                    </div>

                    <div class="pitfall-box">
                        <strong>Pitfall 2: User-As-Owner</strong>
                        <p>A developer (<code>"pete.g"</code>) creates a table, making them the owner. When Pete leaves, the table is orphaned. No one can manage or drop it without <code>ACCOUNTADMIN</code> intervention. This is a critical security risk.</p>
                    </div>

                    <div class="pitfall-box">
                        <strong>Pitfall 3: "Mixed" Roles</strong>
                        <p>A role like <code>FINANCE_TEAM</code> has <code>SELECT</code> on 10 tables, but <code>INSERT</code> on 2 others, and <code>ALL</code> on a different schema. This role is "brittle" and not reusable. We must use the 4-layer model to separate these concerns.</p>
                    </div>
                </div>

                <!-- Slide 7: Best Practices (The "How") -->
                <div class="slide" id="slide7">
                    <h1>Our Path Forward: Best Practices</h1>
                    <p class="subtitle">How we will implement this new model.</p>

                    <div class="practice-box">
                        <h3>1. Collibra as Source of Truth</h3>
                        <p>All "Accountable Owners" and data lifecycle rules will be defined and managed in Collibra. An automated process will sync this metadata to Snowflake <code>COMMENT</code> fields for reference.</p>
                    </div>
                    
                    <div class="practice-box">
                        <h3>2. Abstract Roles for Everything</h3>
                        <p>We will build out the full 4-layer hierarchy. Users *only* get Business Roles. Business Roles *only* get Functional Roles. Functional Roles *only* get Privilege Roles. Privilege Roles are the *only* ones that hold actual <code>GRANT</code> statements.</p>
                    </div>

                    <div class="practice-box">
                        <h3>3. Use <code>ON FUTURE...</code> for Ownership</h3>
                        <p>Every schema will have a corresponding <code>SCHEMA_OWNER_...</code> role. This role will be granted ownership on all future objects in that schema to ensure stable, personless ownership.</p>
                    </div>
                </div>
                
                <!-- Slide 8: The Full Hierarchy (Visual) -->
                <div class="slide" id="slide8">
                    <h1>The Full Hierarchy (Visual)</h1>
                    <p class="subtitle">A visual map of the complete role structure.</p>
                    <pre style="background-color: #f8fafc; color: #334155; padding: 1.5rem; border-radius: 0.5rem; font-size: 1rem; line-height: 1.8; border: 1px solid #e2e8f0;">
  [USER]          [BUSINESS ROLE]         [FUNCTIONAL ROLE]          [PRIVILEGE ROLES]
  "pete.g"   <---   Finance_Analyst_User  <---   DATASCIENTIST   <---   finance_RW
                                                                 <---   sales_READONLY

  "jane.d"   <---   Sales_Analyst_User    <---   SALES_ANALYST   <---   sales_READONLY

  "svc_etl"  <---   ETL_Service_Role      <---   ETL_SERVICE     <---   finance_FA
                                                                 <---   sales_FA

  -------------------------------------------------------------------------------------
  Policy:
  1. Users are ONLY granted Business Roles.
  2. Users can ONLY `USE` Business Roles.
  3. All privileges (SELECT, INSERT) live in Privilege Roles.
  4. All objects are owned by `SCHEMA_OWNER_...` roles.
                    </pre>
                </div>

                <!-- Slide 9: The Core RBAC Policy -->
                <div class="slide" id="slide9">
                    <h1>The Core RBAC Policy</h1>
                    <p class="subtitle">These are the non-negotiable rules for our environment.</p>
                    
                    <div class="policy-box">
                        <ul>
                            <li>Users are **only ever** assigned a <strong>Business Role</strong> (e.g., <code>Finance_Analyst_User</code>).</li>
                            
                            <li>Users **must only** <code>USE</code> their assigned Business Role for their work. All abstract roles (Privilege, Functional) should not be used directly.</li>
                            
                            <li>**No roles** should exist that grant privileges directly on database objects *except* for the base **Privilege Roles** (e.g., <code>finance_READONLY</code>).</li>
                            
                            <li>All other roles (Functional, Business) **must** inherit their permissions *from* these base Privilege Roles.</li>
                            
                            <li>Schema object permissions (<code>SELECT</code>, <code>INSERT</code>) must **only** be granted to a **Privilege Role**.</li>
                            
                            <li>Database-level permissions (<code>USAGE ON SCHEMA</code>) must **only** be granted to a **Privilege Role**.</li>
                            
                            <li>Object ownership must **only** be granted to a <strong><code>SCHEMA_OWNER_...</code></strong> role.</li>
                        </ul>
                    </div>
                </div>

                <!-- Slide 10: Documentation Links -->
                <div class="slide" id="slide10">
                    <h1>Documentation & Proof</h1>
                    <p class="subtitle">Links to official Snowflake documentation for these concepts.</p>

                    <div class="doc-excerpt">
                        <h3>Role-Based Access Control (RBAC)</h3>
                        <blockquote>"Access privileges are assigned to roles, which are in turn assigned to users... Roles can be also granted to other roles, creating a hierarchy of roles."</blockquote>
                        <a href="https://docs.snowflake.com/en/user-guide/security-access-control-overview" target="_blank">Overview of Access Control</a>
                    </div>
                    
                    <div class="doc-excerpt" style="margin-top: 1.5rem;">
                        <h3>GRANT OWNERSHIP ON FUTURE...</h3>
                        <blockquote>"Grants ownership on new (i.e. future) objects of a specified type in a database or schema to a role... This is a convenient way to assign ownership of all new objects created by a role..."</blockquote>
                        <a href="https://docs.snowflake.com/en/sql-reference/sql/grant-ownership" target="_blank">GRANT OWNERSHIP</a>
                    </div>

                    <div class="doc-excerpt" style="margin-top: 1.5rem;">
                        <h3>Using COMMENT for Metadata</h3>
                        <blockquote>"Adds a comment or overwrites an existing comment for an existing object... You can also use this command to add comments to individual table columns..."</blockquote>
                        <a href="https://docs.snowflake.com/en/sql-reference/sql/comment" target="_blank">COMMENT</a>
                    </div>
                </div>

                <!-- Slide 11: Action Plan -->
                <div class="slide" id="slide11">
                    <h1>Our Action Plan</h1>
                    <p class="subtitle">How we will execute this transition.</p>
                    
                    <ol>
                        <li><strong>Audit:</strong> Identify all existing roles that violate this policy (e.g., one-off grants, user-owned objects).</li>
                        <li><strong>Build:</strong> Script and deploy the new, abstract 4-layer role hierarchies in code.</li>
                        <li><strong>Automate:</strong> Connect Collibra to our Snowflake environment to automate the syncing of "Accountable Owner" metadata.</li>
                        <li><strong>Remediate:</strong> Transfer ownership of all existing objects to the new <code>SCHEMA_OWNER_...</code> roles.</li>
                        <li><strong>Migrate:</strong> Re-grant user permissions using the new Business Roles and revoke all old, non-compliant roles.</li>
                        <li><strong>Enforce:</strong> Implement monitoring to alert on any new grants that violate this policy.</li>
                    </ol>
                </div>

                <!-- Slide 12: End-to-End Test Script -->
                <div class="slide" id="slide12">
                    <h1>End-to-End Test Script</h1>
                    <p class="subtitle">A complete script to set up, test, and verify this entire model.</p>
                    <p>This script is idempotent. It can be run multiple times and will clean up and rebuild the environment to ensure a valid test.</p>

                    <button class="collapsible-trigger active">Show Full RBAC Test Script (Snowflake)</button>
                    <div class="collapsible-content" style="max-height: 500px; overflow-y: auto;">
                        <button class="copy-button" title="Copy to clipboard">Copy</button>
                        <pre style="padding-top: 3rem;"><code class="language-sql"><span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- PART 0: INITIAL ADMIN SETUP (Run as ACCOUNTADMIN)</span>
<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- Create the admin role that will manage the hierarchy</span>
<span class="sql-keyword">USE ROLE</span> ACCOUNTADMIN;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> business_role_admin;
<span class="sql-keyword">GRANT CREATE ROLE ON ACCOUNT TO ROLE</span> business_role_admin;
<span class="sql-keyword">GRANT CREATE USER ON ACCOUNT TO ROLE</span> business_role_admin;
<span class="sql-keyword">GRANT CREATE DATABASE ON ACCOUNT TO ROLE</span> business_role_admin;
<span class="sql-keyword">GRANT CREATE WAREHOUSE ON ACCOUNT TO ROLE</span> business_role_admin;
<span class="sql-keyword">GRANT ROLE</span> business_role_admin <span class="sql-keyword">TO ROLE</span> SYSADMIN; <span class="sql-comment">-- SYSADMIN will run the build</span>


<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- PART 1: SETUP (Run as SYSADMIN or SECURITYADMIN)</span>
<span class="sql-comment">-- =========================================================</span>
<span class="sql-keyword">USE ROLE</span> SYSADMIN;
<span class="sql-keyword">CREATE OR REPLACE DATABASE</span> RBAC_TESTING;
<span class="sql-keyword">CREATE OR REPLACE WAREHOUSE</span> TEST_WH WAREHOUSE_SIZE=XSMALL;
<span class="sql-keyword">GRANT ALL ON WAREHOUSE</span> TEST_WH <span class="sql-keyword">TO ROLE</span> SYSADMIN;

<span class="sql-keyword">USE</span> RBAC_TESTING;

<span class="sql-comment">-- --- 1.0: SETUP TEST RESULT TABLE ---</span>
<span class="sql-comment">-- Create a temporary table to collate all test results</span>
<span class="sql-keyword">CREATE OR REPLACE TEMPORARY TABLE</span> RBAC_TESTING.PUBLIC.test_results (
    test_name <span class="sql-keyword">STRING</span>,
    status <span class="sql-keyword">STRING</span>,
    details <span class="sql-keyword">STRING</span>
);
<span class="sql-comment">-- Grant all roles (via PUBLIC) the ability to insert results</span>
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> RBAC_TESTING.PUBLIC <span class="sql-keyword">TO ROLE</span> PUBLIC;
<span class="sql-keyword">GRANT INSERT, SELECT ON TABLE</span> RBAC_TESTING.PUBLIC.test_results <span class="sql-keyword">TO ROLE</span> PUBLIC;


<span class="sql-comment">-- --- 1.1: FINANCE SCHEMA SETUP ---</span>
<span class="sql-keyword">CREATE OR REPLACE SCHEMA</span> FINANCE;
<span class="sql-keyword">COMMENT ON SCHEMA</span> FINANCE <span class="sql-keyword">IS</span> <span class="sql-string">'{"AccountableOwner": "finance.director@company.com"}'</span>;

<span class="sql-comment">-- Create Privilege Roles</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_READONLY;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_RW;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> finance_FA;
<span class="sql-comment">-- Create Ownership Role</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> SCHEMA_OWNER_FINANCE;

<span class="sql-comment">-- Grant Ownership (MUST be done BEFORE other grants)</span>
<span class="sql-keyword">GRANT OWNERSHIP ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE <span class="sql-keyword">REVOKE CURRENT GRANTS</span>;
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE VIEWS IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_FINANCE;

<span class="sql-comment">-- Grant Privileges to Privilege Roles</span>
<span class="sql-keyword">GRANT USAGE ON DATABASE</span> RBAC_TESTING <span class="sql-keyword">TO ROLE</span> finance_READONLY;
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;
<span class="sql-keyword">GRANT SELECT ON ALL TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;
<span class="sql-keyword">GRANT SELECT ON FUTURE TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_READONLY;

<span class="sql-keyword">GRANT INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_RW;
<span class="sql-keyword">GRANT INSERT, UPDATE, DELETE ON FUTURE TABLES IN SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_RW;

<span class="sql-keyword">GRANT ALL ON SCHEMA</span> FINANCE <span class="sql-keyword">TO ROLE</span> finance_FA;
<span class="sql-keyword">GRANT ROLE</span> SCHEMA_OWNER_FINANCE <span class="sql-keyword">TO ROLE</span> finance_FA; <span class="sql-comment">-- Allow FA to create objects</span>

<span class="sql-comment">-- Stack Privilege Roles</span>
<span class="sql-keyword">GRANT ROLE</span> finance_READONLY <span class="sql-keyword">TO ROLE</span> finance_RW;
<span class="sql-keyword">GRANT ROLE</span> finance_RW <span class="sql-keyword">TO ROLE</span> finance_FA;


<span class="sql-comment">-- --- 1.2: SALES SCHEMA SETUP ---</span>
<span class="sql-keyword">CREATE OR REPLACE SCHEMA</span> SALES;
<span class="sql-keyword">COMMENT ON SCHEMA</span> SALES <span class="sql-keyword">IS</span> <span class="sql-string">'{"AccountableOwner": "sales.vp@company.com"}'</span>;

<span class="sql-comment">-- Create Privilege Roles</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> sales_READONLY;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> sales_RW;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> sales_FA;
<span class="sql-comment">-- Create Ownership Role</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> SCHEMA_OWNER_SALES;

<span class="sql-comment">-- Grant Ownership (MUST be done BEFORE other grants)</span>
<span class="sql-keyword">GRANT OWNERSHIP ON SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_SALES <span class="sql-keyword">REVOKE CURRENT GRANTS</span>;
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_SALES;
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE TABLES IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_SALES;
<span class="sql-keyword">GRANT OWNERSHIP ON FUTURE VIEWS IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> SCHEMA_OWNER_SALES;

<span class="sql-comment">-- Grant Privileges to Privilege Roles</span>
<span class="sql-keyword">GRANT USAGE ON DATABASE</span> RBAC_TESTING <span class="sql-keyword">TO ROLE</span> sales_READONLY;
<span class="sql-keyword">GRANT USAGE ON SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_READONLY;
<span class="sql-keyword">GRANT SELECT ON ALL TABLES IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_READONLY;
<span class="sql-keyword">GRANT SELECT ON FUTURE TABLES IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_READONLY;

<span class="sql-keyword">GRANT INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_RW;
<span class="sql-keyword">GRANT INSERT, UPDATE, DELETE ON FUTURE TABLES IN SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_RW;

<span class="sql-keyword">GRANT ALL ON SCHEMA</span> SALES <span class="sql-keyword">TO ROLE</span> sales_FA;
<span class="sql-keyword">GRANT ROLE</span> SCHEMA_OWNER_SALES <span class="sql-keyword">TO ROLE</span> sales_FA; <span class="sql-comment">-- Allow FA to create objects</span>

<span class="sql-comment">-- Stack Privilege Roles</span>
<span class="sql-keyword">GRANT ROLE</span> sales_READONLY <span class="sql-keyword">TO ROLE</span> sales_RW;
<span class="sql-keyword">GRANT ROLE</span> sales_RW <span class="sql-keyword">TO ROLE</span> sales_FA;


<span class="sql-comment">-- --- 1.3: CREATE FUNCTIONAL ROLES ---</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> DATASCIENTIST;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> SALES_ANALYST;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> ETL_SERVICE;

<span class="sql-comment">-- Grant privileges to Functional Roles</span>
<span class="sql-keyword">GRANT ROLE</span> finance_RW <span class="sql-keyword">TO ROLE</span> DATASCIENTIST;
<span class="sql-keyword">GRANT ROLE</span> sales_READONLY <span class="sql-keyword">TO ROLE</span> DATASCIENTIST;

<span class="sql-keyword">GRANT ROLE</span> sales_READONLY <span class="sql-keyword">TO ROLE</span> SALES_ANALYST;

<span class="sql-keyword">GRANT ROLE</span> finance_FA <span class="sql-keyword">TO ROLE</span> ETL_SERVICE;
<span class="sql-keyword">GRANT ROLE</span> sales_FA <span class="sql-keyword">TO ROLE</span> ETL_SERVICE;


<span class="sql-comment">-- --- 1.4: CREATE BUSINESS ROLES & USERS ---</span>
<span class="sql-keyword">USE ROLE</span> business_role_admin; <span class="sql-comment">-- This role can create users/roles</span>

<span class="sql-comment">-- Business Roles</span>
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> Sales_Analyst_User;
<span class="sql-keyword">CREATE OR REPLACE ROLE</span> ETL_Service_Role;

<span class="sql-comment">-- Link Functional to Business Roles</span>
<span class="sql-keyword">GRANT ROLE</span> DATASCIENTIST <span class="sql-keyword">TO ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">GRANT ROLE</span> SALES_ANALYST <span class="sql-keyword">TO ROLE</span> Sales_Analyst_User;
<span class="sql-keyword">GRANT ROLE</span> ETL_SERVICE <span class="sql-keyword">TO ROLE</span> ETL_Service_Role;

<span class="sql-comment">-- Create Test Users</span>
<span class="sql-keyword">CREATE OR REPLACE USER</span> test_fin_analyst PASSWORD=<span class="sql-string">'test'</span> DEFAULT_ROLE=Finance_Analyst_User DEFAULT_WAREHOUSE=TEST_WH;
<span class="sql-keyword">CREATE OR REPLACE USER</span> test_sales_analyst PASSWORD=<span class="sql-string">'test'</span> DEFAULT_ROLE=Sales_Analyst_User DEFAULT_WAREHOUSE=TEST_WH;
<span class="sql-keyword">CREATE OR REPLACE USER</span> test_etl_service PASSWORD=<span class="sql-string">'test'</span> DEFAULT_ROLE=ETL_Service_Role DEFAULT_WAREHOUSE=TEST_WH;

<span class="sql-comment">-- Grant Business Roles to Users</span>
<span class="sql-keyword">GRANT ROLE</span> Finance_Analyst_User <span class="sql-keyword">TO USER</span> test_fin_analyst;
<span class="sql-keyword">GRANT ROLE</span> Sales_Analyst_User <span class="sql-keyword">TO USER</span> test_sales_analyst;
<span class="sql-keyword">GRANT ROLE</span> ETL_Service_Role <span class="sql-keyword">TO USER</span> test_etl_service;

<span class="sql-comment">-- Grant WAREHOUSE usage to the Business Roles</span>
<span class="sql-keyword">GRANT USAGE ON WAREHOUSE</span> TEST_WH <span class="sql-keyword">TO ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">GRANT USAGE ON WAREHOUSE</span> TEST_WH <span class="sql-keyword">TO ROLE</span> Sales_Analyst_User;
<span class="sql-keyword">GRANT USAGE ON WAREHOUSE</span> TEST_WH <span class="sql-keyword">TO ROLE</span> ETL_Service_Role;


<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- PART 2: RUN ASSERTION TESTS (Snowflake Scripting)</span>
<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- --- 2.1: TEST ETL (FA on both) ---</span>
<span class="sql-keyword">USE ROLE</span> ETL_Service_Role;
<span class="sql-keyword">USE WAREHOUSE</span> TEST_WH;
<span class="sql-keyword">USE DATABASE</span> RBAC_TESTING;
<span class="sql-keyword">USE SCHEMA</span> FINANCE;

<span class="sql-keyword">EXECUTE IMMEDIATE</span> <span class="sql-string">'
BEGIN
  -- Test 2.1.1: Create FINANCE table (SUCCESS expected)
  BEGIN
    CREATE OR REPLACE TABLE finance_transactions (id INT, amount DECIMAL(10,2));
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.1.1'', ''PASS'', ''Created finance_transactions'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.1.1'', ''FAIL'', ''Failed to create finance_transactions. Error: '' || SQLERRM);
  END;

  -- Test 2.1.2: Create SALES table (SUCCESS expected)
  BEGIN
    CREATE OR REPLACE TABLE SALES.sales_deals (id INT, value DECIMAL(10,2));
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.1.2'', ''PASS'', ''Created SALES.sales_deals'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.1.2'', ''FAIL'', ''Failed to create SALES.sales_deals. Error: '' || SQLERRM);
  END;

  RETURN ''Part 2.1 Complete'';
END;
'</span>;

<span class="sql-comment">-- Test 2.1.3 & 2.1.4: Check ownership (run as SYSADMIN)</span>
<span class="sql-keyword">USE ROLE</span> SYSADMIN;
<span class="sql-comment">-- This query proves ownership. The owner should be the ROLE, not the USER.</span>
<span class="sql-keyword">SHOW TABLES LIKE</span> <span class="sql-string">'%finance_transactions%'</span> IN SCHEMA RBAC_TESTING.FINANCE;
<span class="sql-keyword">INSERT INTO</span> RBAC_TESTING.PUBLIC.test_results (test_name, status, details)
  <span class="sql-keyword">SELECT</span> <span class="sql-string">'Test 2.1.3 (Ownership)'</span>, 
         <span class="sql-keyword">CASE WHEN</span> "owner" = <span class="sql-string">'SCHEMA_OWNER_FINANCE'</span> <span class="sql-keyword">THEN</span> <span class="sql-string">'PASS'</span> <span class="sql-keyword">ELSE</span> <span class="sql-string">'FAIL'</span> <span class="sql-keyword">END</span>, 
         <span class="sql-string">'FINANCE_TRANSACTIONS owner is: '</span> || "owner" 
  <span class="sql-keyword">FROM</span> <span class="sql-keyword">TABLE</span>(RESULT_SCAN(LAST_QUERY_ID())) <span class="sql-keyword">WHERE</span> "name" = <span class="sql-string">'FINANCE_TRANSACTIONS'</span>;

<span class="sql-keyword">SHOW TABLES LIKE</span> <span class="sql-string">'%sales_deals%'</span> IN SCHEMA RBAC_TESTING.SALES;
<span class="sql-keyword">INSERT INTO</span> RBAC_TESTING.PUBLIC.test_results (test_name, status, details)
  <span class="sql-keyword">SELECT</span> <span class="sql-string">'Test 2.1.4 (Ownership)'</span>, 
         <span class="sql-keyword">CASE WHEN</span> "owner" = <span class="sql-string">'SCHEMA_OWNER_SALES'</span> <span class="sql-keyword">THEN</span> <span class="sql-string">'PASS'</span> <span class="sql-keyword">ELSE</span> <span class="sql-string">'FAIL'</span> <span class="sql-keyword">END</span>, 
         <span class="sql-string">'SALES_DEALS owner is: '</span> || "owner" 
  <span class="sql-keyword">FROM</span> <span class="sql-keyword">TABLE</span>(RESULT_SCAN(LAST_QUERY_ID())) <span class="sql-keyword">WHERE</span> "name" = <span class="sql-string">'SALES_DEALS'</span>;


<span class="sql-comment">-- --- 2.2: TEST FINANCE ANALYST (RW in Fin, RO in Sales) ---</span>
<span class="sql-keyword">USE ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">USE WAREHOUSE</span> TEST_WH;
<span class="sql-keyword">USE DATABASE</span> RBAC_TESTING;
<span class="sql-keyword">USE SCHEMA</span> FINANCE;

<span class="sql-keyword">EXECUTE IMMEDIATE</span> <span class="sql-string">'
BEGIN
  -- Test 2.2.1: Can write to FINANCE (SUCCESS expected)
  BEGIN
    INSERT INTO finance_transactions VALUES (1, 100.50);
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.2.1'', ''PASS'', ''INSERT into finance_transactions succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.2.1'', ''FAIL'', ''INSERT into finance_transactions failed. Error: '' || SQLERRM);
  END;

  -- Test 2.2.2: Can read from SALES (SUCCESS expected)
  BEGIN
    SELECT * FROM SALES.sales_deals;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.2.2'', ''PASS'', ''SELECT from SALES.sales_deals succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.2.2'', ''FAIL'', ''SELECT from SALES.sales_deals failed. Error: '' || SQLERRM);
  END;

  -- Test 2.2.3: Can write to SALES (FAILURE expected)
  BEGIN
    INSERT INTO SALES.sales_deals VALUES (2, 500.00);
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.2.3'', ''FAIL'', ''INSERT into SALES.sales_deals succeeded but should have failed.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.2.3'', ''PASS'', ''INSERT into SALES.sales_deals failed as expected. Error: '' || SQLERRM);
  END;
  
  RETURN ''Part 2.2 Complete'';
END;
'</span>;


<span class="sql-comment">-- --- 2.3: TEST SALES ANALYST (RO in Sales, NO access in Fin) ---</span>
<span class="sql-keyword">USE ROLE</span> Sales_Analyst_User;
<span class="sql-keyword">USE WAREHOUSE</span> TEST_WH;
<span class="sql-keyword">USE DATABASE</span> RBAC_TESTING;
<span class="sql-keyword">USE SCHEMA</span> SALES;

<span class="sql-keyword">EXECUTE IMMEDIATE</span> <span class="sql-string">'
BEGIN
  -- Test 2.3.1: Can read from SALES (SUCCESS expected)
  BEGIN
    SELECT * FROM sales_deals;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.3.1'', ''PASS'', ''SELECT from SALES.sales_deals succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.3.1'', ''FAIL'', ''SELECT from SALES.sales_deals failed. Error: '' || SQLERRM);
  END;

  -- Test 2.3.2: Can write to SALES (FAILURE expected)
  BEGIN
    INSERT INTO sales_deals VALUES (3, 750.00);
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.3.2'', ''FAIL'', ''INSERT into SALES.sales_deals succeeded but should have failed.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.3.2'', ''PASS'', ''INSERT into SALES.sales_deals failed as expected. Error: '' || SQLERRM);
  END;

  -- Test 2.3.3: Can read from FINANCE (FAILURE expected)
  BEGIN
    SELECT * FROM FINANCE.finance_transactions;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.3.3'', ''FAIL'', ''SELECT from FINANCE.finance_transactions succeeded but should have failed.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.3.3'', ''PASS'', ''SELECT from FINANCE.finance_transactions failed as expected. Error: '' || SQLERRM);
  END;
  
  RETURN ''Part 2.3 Complete'';
END;
'</span>;


<span class="sql-comment">-- --- 2.4: TEST ABSTRACT ROLE USAGE (as Finance Analyst) ---</span>
<span class="sql-keyword">USE ROLE</span> Finance_Analyst_User;
<span class="sql-keyword">USE WAREHOUSE</span> TEST_WH;
<span class="sql-keyword">USE DATABASE</span> RBAC_TESTING;

<span class="sql-keyword">EXECUTE IMMEDIATE</span> <span class="sql-string">'
BEGIN
  -- Test 2.4.1: Try to use the Functional Role (SUCCESS expected)
  -- NOTE: A user *can* USE inherited roles. Our policy is
  -- procedural, not a hard technical block.
  BEGIN
    USE ROLE DATASCIENTIST;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.4.1'', ''PASS'', ''USE ROLE DATASCIENTIST succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.4.1'', ''FAIL'', ''USE ROLE DATASCIENTIST failed. Error: '' || SQLERRM);
  END;

  -- Test 2.4.2: Try to use the Privilege Role (SUCCESS expected)
  BEGIN
    USE ROLE finance_RW;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.4.2'', ''PASS'', ''USE ROLE finance_RW succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.4.2'', ''FAIL'', ''USE ROLE finance_RW failed. Error: '' || SQLERRM);
  END;

  -- Test 2.4.3: Revert to the Business Role (SUCCESS expected)
  BEGIN
    USE ROLE Finance_Analyst_User;
    INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
      VALUES (''Test 2.4.3'', ''PASS'', ''USE ROLE Finance_Analyst_User succeeded as expected.'');
  EXCEPTION
    WHEN OTHER THEN
      INSERT INTO RBAC_TESTING.PUBLIC.test_results (test_name, status, details) 
        VALUES (''Test 2.4.3'', ''FAIL'', ''USE ROLE Finance_Analyst_User failed. Error: '' || SQLERRM);
  END;
  
  RETURN ''Part 2.4 Complete'';
END;
'</span>;


<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- PART 2.5: REVIEW TEST RESULTS (Run as SYSADMIN)</span>
<span class="sql-comment">-- =========================================================</span>
<span class="sql-keyword">USE ROLE</span> SYSADMIN;
<span class="sql-comment">-- This single table shows the PASS/FAIL status of all tests.</span>
<span class="sql-keyword">SELECT</span> * <span class="sql-keyword">FROM</span> RBAC_TESTING.PUBLIC.test_results <span class="sql-keyword">ORDER BY</span> test_name;


<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">-- PART 3: CLEANUP (Run as SYSADMIN)</span>
<span class="sql-comment">-- =========================================================</span>
<span class="sql-comment">/*
USE ROLE SYSADMIN;
DROP DATABASE IF EXISTS RBAC_TESTING;
DROP WAREHOUSE IF EXISTS TEST_WH;

USE ROLE ACCOUNTADMIN;
DROP USER IF EXISTS test_fin_analyst;
DROP USER IF EXISTS test_sales_analyst;
DROP USER IF EXISTS test_etl_service;

DROP ROLE IF EXISTS Finance_Analyst_User;
DROP ROLE IF EXISTS Sales_Analyst_User;
DROP ROLE IF EXISTS ETL_Service_Role;

DROP ROLE IF EXISTS DATASCIENTIST;
DROP ROLE IF EXISTS SALES_ANALYST;
DROP ROLE IF EXISTS ETL_SERVICE;

DROP ROLE IF EXISTS finance_READONLY;
DROP ROLE IF EXISTS finance_RW;
DROP ROLE IF EXISTS finance_FA;
DROP ROLE IF EXISTS SCHEMA_OWNER_FINANCE;

DROP ROLE IF EXISTS sales_READONLY;
DROP ROLE IF EXISTS sales_RW;
DROP ROLE IF EXISTS sales_FA;
DROP ROLE IF EXISTS SCHEMA_OWNER_SALES;

DROP ROLE IF EXISTS business_role_admin;

-- The temporary table 'test_results' is dropped automatically
-- when the session ends.
*/</span>
                        </code></pre>
                    </div>
                </div>

            </div>
        </div>

        <!-- Navigation -->
        <div id="nav-controls">
            <button id="prev-button" class="nav-button" disabled>Previous</button>
            <div id="slide-counter">Slide 1 of 12</div>
            <button id="next-button" class="nav-button">Next</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deck = document.getElementById('slide-deck');
            const slides = document.querySelectorAll('.slide');
            const slideCount = slides.length;
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const slideCounter = document.getElementById('slide-counter');
            
            let currentSlide = 0;

            function showSlide(index) {
                // Check if the slide exists
                if (!slides[index]) {
                    console.error('Slide index out of bounds:', index);
                    return;
                }
                
                // Remove 'active' class from all slides
                slides.forEach(slide => slide.classList.remove('active'));
                
                // Add 'active' class to the current slide
                slides[index].classList.add('active');
                
                // Move the slide deck
                deck.style.transform = `translateX(-${index * 100}%)`;
                
                // Update counter
                slideCounter.textContent = `Slide ${index + 1} of ${slideCount}`;
                
                // Update buttons
                prevButton.disabled = (index === 0);
                nextButton.disabled = (index === slideCount - 1);
                
                currentSlide = index;
            }

            prevButton.addEventListener('click', () => {
                if (currentSlide > 0) {
                    showSlide(currentSlide - 1);
                }
            });

            nextButton.addEventListener('click', () => {
                if (currentSlide < slideCount - 1) {
                    showSlide(currentSlide + 1);
                }
            });

            // --- Collapsible Code Blocks ---
            const triggers = document.querySelectorAll('.collapsible-trigger');
            triggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        // Check if content is already open from HTML (like test script)
                        if (this.classList.contains('active')) {
                            content.style.maxHeight = content.scrollHeight + "px";
                        } else {
                            content.style.maxHeight = null;
                        }
                    }
                });
            });
            
            // --- Auto-open the active collapsible script ---
            const activeTrigger = document.querySelector('.collapsible-trigger.active');
            if (activeTrigger) {
                const content = activeTrigger.nextElementSibling;
                if (content) {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            }


            // --- Copy Button Logic ---
            const copyButtons = document.querySelectorAll('.copy-button');
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const contentDiv = this.parentElement;
                    const pre = contentDiv.querySelector('pre');
                    const code = pre.querySelector('code');
                    
                    // Create a range to select the text
                    const range = document.createRange();
                    range.selectNode(code);
                    
                    // Get the text, preserving line breaks
                    // Using innerText or textContent can vary. Let's build it.
                    let codeText = '';
                    const lines = code.childNodes;
                    lines.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            codeText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            // This handles the spans
                            codeText += node.textContent;
                        }
                    });
                    
                    // Use hidden textarea to copy text
                    // This is the most reliable method for iframe clipboard access
                    const textArea = document.createElement('textarea');
                    textArea.value = codeText.trim(); // Trim to remove leading/trailing whitespace
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        
                        // Visual Feedback
                        this.textContent = 'Copied!';
                        this.classList.add('copied');
                        
                        setTimeout(() => {
                            this.textContent = 'Copy';
                            this.classList.remove('copied');
                        }, 2000);

                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        this.textContent = 'Error';
                    }
                    document.body.removeChild(textArea);
                });
            });

            // Initialize first slide
            showSlide(0);
        });
    </script>

</body>
</html>

